<!doctype html>
<html>
<head>
    <title>Many polygons with geojson-vt on Leaflet</title>
    <meta charset="utf-8">

    <style>
        html, body {
            height: 100%;
            padding: 0;
            margin: 0;
            height: 100%;
            font-family: Tahoma, Geneva, Verdana, sans-serif;
            font-size:12px;
            color:#808080;
        }

        #map {
            position: absolute;
            height: 100%;
            width: 100%;
            background-color: #fff;
        }
    </style>
   

</head>
<body>
    <div id="map"></div>
    
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
    <script src="http://www.sumbera.com/gist/js/leaflet/canvas/L.CanvasTiles.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script>

        var leafletMap = L.map('map',{
            minZoom : 11,
            maxZoom : 14
        }).setView([28.65717437884571,77.11843944032873], 11);
        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png').addTo(leafletMap);

        var tileLayer = L.canvasTiles()
                      .params({ debug: false, padding: 5 })
                      .drawing(drawingOnCanvas)
                   
        var pad = 0;

        // tileLayer.addTo(leafletMap);
        
        function drawingOnCanvas(canvasOverlay, params) {

            var bounds = params.bounds;
            params.tilePoint.z = params.zoom;

            var ctx = params.canvas.getContext('2d');
            ctx.globalCompositeOperation = 'source-over';


            console.log('getting tile z' + params.tilePoint.z + '-' + params.tilePoint.x + '-' + params.tilePoint.y);

            d3.json("http://localhost:7777/tiles/"+params.tilePoint.z+"/"+params.tilePoint.x+"/"+params.tilePoint.y+".json",function(tile){
                if (!tile) {
                    console.log('tile empty');
                    return;
                }

                ctx.clearRect(0, 0, params.canvas.width, params.canvas.height);

                var features = tile.features;

                ctx.strokeStyle = 'grey';

                for (var i = 0; i < features.length; i++) {
                    var feature = features[i],
                        type = feature.type;

                    ctx.fillStyle = feature.tags.color ? feature.tags.color : '#CCC';
                    ctx.beginPath();

                    for (var j = 0; j < feature.geometry.length; j++) {
                        var geom = feature.geometry[j];

                        if (type === 1) {
                            ctx.arc(geom[0] * ratio + pad, geom[1] * ratio + pad, 2, 0, 2 * Math.PI, false);
                            continue;
                        }

                        for (var k = 0; k < geom.length; k++) {
                            var p = geom[k];
                            var extent = 4096;
                           
                            var x = p[0] / extent * 256;
                            var y = p[1] / extent * 256;
                            if (k) ctx.lineTo(x  + pad, y   + pad);
                            else ctx.moveTo(x  + pad, y  + pad);
                        }
                    }

                    if (type === 3 || type === 1) ctx.fill('evenodd');
                    ctx.stroke();
                }
            })
        };


    </script>
</body>
</html>
